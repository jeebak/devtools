#!/usr/bin/env bash

# https://gist.github.com/waylan/4080362
# drush sql-create --db-su=root --db-su-pw=root  ${PWD##/*/} | sed 's/-//g')

function errcho() {
  # echo to strerr
  >&2 echo "$@"
}

accpl_self="${0##/*/}"
destdir="$(egrep -o '[^/]+/[^/]*$' <<< "${0%/bin/$accpl_self}")"
confdir="${XDG_CONFIG_HOME:-$HOME/.config}/$destdir"

function accpl.help() {
  cat <<EOT
Usage: $accpl_self <subcommand> [options]

  MySQL Helper Subcommands:
    c         Create DB based on drupal/joomla/wp creds, or \$PWD
    drop      DROP DB and *USER* based on drupal/joomla/wp creds, or \$PWD
    p         Change DB password based on drupal/joomla/wp creds, or \$PWD
    l         MySQL Shell  Login based on drupal/joomla/wp creds, or \$PWD
    q         MySQL Query: $accpl_self q [\$query] [\$database] [\$user] [\$passwd]
    t         SHOW TABLES based on drupal/joomla/wp creds, or \$PWD
    trunc     TRUNCATE TABLE \$2 in db based on drupal/joomla/wp creds, or \$PWD
    d         SHOW DATABASES;
    f         FLUSH PRIVILEGES;

  CMS (Drupal/Joomla/WordPress) Helper Subcommands: (\$dr == \$drupal_root)
    dump      Drush/wp cache clear, then: sql dump to db/ folder
    seed      Drush/wp db drop, then seed db via: sql cli with \$2
    addme     Drush/wp user-create, and user-add-role (administrator / programmer)
                as appropriate
    ccc       Compass clean, compile, then drush/wp cache clear
    cw        Compass watch, for drupal/wp

  Drupal Only: (\$dr == \$drupal_root)
    si        Drush site-install standard based on \$PWD
    dls       Add drupal *local* settings.php file (if it exists) based on \$dr
    els       Edit drupal *local* settings.php file (if it exists) based on \$dr
                falling back to: \$dr/sites/default/settings.php
    exfe      Extract Drupal Features .tar file to: \$dr/sites/all/modules/features
                falling back to: \$dr/sites/all/modules/custom
                then finally to: \$dr/sites/all/modules before failing
    dinit     Drupal init (for newly clone-d MT drupal project.) Will run:
                $accpl_self {dls,c},
                cap \$stage files:pull, $accpl_self fp,
                cap \$stage db:down, $accpl_self seed db/default_\${stage}.sql
              \$stage defaulting to 'prod' unless provided as a parameter

  *** Requires a clone at: \$HOME/.ghq/git.drupal.org/project/drupal ***
    cd        Core Diff (useful to examine inherited legacy projects)
    cus       List custom files (outside of core and contrib)

  Apache Helper Subcommands:
    adb       Simple Apache debug output (requires sudo)
    aa        Examine Apache access logs via: lnav, if available, tail -f, otherwise
    ae        Examine Apache  error logs via: lnav, if available, tail -f, otherwise
    fp        Fix Permissions for concrete5/drupal/joomla/wp content dirs
                - OR - as provided as parameters
    genssl    Generate Self-signed SSL Certs (server.{crt,csr,key}, or specify name)

  Misc. Helper Subcommands:
    ssh       Ssh's to ssh_options[:user]@#{gateway} from Capfile, based on current
              git branch

    exam      Examine archive files (list contents, good idea to run 1st, before...)
    ex        Extract archive files (NOTE: contents may not all be contained in a
                folder and may litter your \$PWD)

EOT
}

function accpl.__call_drush() {
  local DRUSH drupal_root

  DRUSH="$(command -v drush)"
  [[ -z "$DRUSH" ]] && errcho "Drush not found!" && exit 127

  drupal_root="$(accpl.__get_drupal_root)"
  "$DRUSH" -r "$drupal_root" "$@"
}

function accpl.__call_joomla() {
  local JOOMLA joomla_root

  JOOMLA="$(command -v joomla)"
  [[ -z "$JOOMLA" ]] && errcho "Joomla-console not found!" && exit 127

  joomla_root="$(accpl.__get_joomla_root)"
  "$JOOMLA" --www="$joomla_root" "$@"
}

function accpl.__call_wp_cli() {
  local WPCLI wordpress_root

  WPCLI="$(command -v wp)"
  [[ -z "$WPCLI" ]] && errcho "Wp-cli not found!" && exit 127

  wordpress_root="$(accpl.__get_wordpress_root)"
  "$WPCLI" --path="$wordpress_root" "$@"
}

function accpl.__get_clean_mysql_db() {
  local git_root project_name

  git_root="$(accpl.__get_git_root)"
  project_name="${git_root##/*/}"

  [[ -z "$project_name" ]] && project_name="${PWD##/*/}"
  project_name="${project_name//[^a-zA-Z0-9]/}"

  # MySQL usernames have 16 character limit
  echo "${project_name:0:16}"
}

function accpl.__get_mysql_creds() {
  local dbname dbpassword dbusername clean_mysql_db

  if accpl.__is_concrete5; then
    set -- $(accpl.__get_concrete5_creds)
  elif accpl.__is_drupal; then
    set -- $(accpl.__get_drupal_creds)
  elif accpl.__is_joomla; then
    set -- $(accpl.__get_joomla_creds)
  elif accpl.__is_wordpress; then
    set -- $(accpl.__get_wordpress_creds)
  fi

  if [[ $# -ne 3 ]]; then
    clean_mysql_db="$(accpl.__get_clean_mysql_db)"
  fi

  dbname="${1:-$clean_mysql_db}"
  dbpassword="${2:-$clean_mysql_db}"
  dbusername="${3:-$clean_mysql_db}"

  echo "$dbname" "$dbpassword" "$dbusername"
}

function accpl.__get_cred() {
  local destfile destdir userprompt cred

  destfile="$1"
  destdir="${destfile%/*}"

  userprompt="$2"

  [[ ! -d "$destdir" ]] && mkdir -p "$destdir" && chmod 700 "$destdir"

  if [[ -r "$destfile" ]]; then
    cred="$(cat "$destfile")"
  else
    [[ ! -z "$3" ]] && stty -echo
    read -r -p "$userprompt " cred
    [[ ! -z "$3" ]] && stty echo
    echo "$cred" > "$destfile" && chmod 600 "$destfile"
  fi

  echo "$cred"
}

function accpl.__get_mysql_root_passwd() {
  accpl.__get_cred "$confdir/creds/mysql/root-passwd.txt" "MySQL root password:" noecho
}

function accpl.__get_my_drupal_username() {
  accpl.__get_cred "$confdir/creds/drupal/username.txt" "Your default Drupal username:"
}

function accpl.__get_my_drupal_email_address() {
  accpl.__get_cred "$confdir/creds/drupal/email.txt" "Your default Drupal email:"
}

function accpl.__get_my_drupal_passwd() {
  accpl.__get_cred "$confdir/creds/drupal/passwd.txt" "Your default Drupal password:" noecho
}

function accpl.__get_my_wordpress_username() {
  accpl.__get_cred "$confdir/creds/wordpress/username.txt" "Your default Wordpress username:"
}

function accpl.__get_my_wordpress_email_address() {
  accpl.__get_cred "$confdir/creds/wordpress/email.txt" "Your default WordPress email:"
}

function accpl.__get_my_wordpress_passwd() {
  accpl.__get_cred "$confdir/creds/wordpress/passwd.txt" "Your default WordPress password:" noecho
}

function accpl.__db_query() {
  local clean_mysql_db query db user passwd

  clean_mysql_db="$(accpl.__get_clean_mysql_db)"
  # Params: Run this query, on this database, using this username, and this password
  # Empty query, gets mysql shell
  query="${1/\{_DB_SELF_\}/$clean_mysql_db}"
  db="${2:-$clean_mysql_db}"
  user="${3:-$clean_mysql_db}"
  passwd="${4:-$clean_mysql_db}"

  if accpl.__is_drupal && [[ $# -lt 2 ]]; then
    if [[ -z "$query" ]]; then
      accpl.__call_drush sql-cli
    else
      accpl.__call_drush sql-query "$query"
    fi
  elif accpl.__is_wordpress && [[ $# -lt 2 ]]; then
    if [[ -z "$query" ]]; then
      accpl.__call_wp_cli db cli
    else
      accpl.__call_wp_cli db query "$query"
    fi
  else
    [[ "$user" = root ]] && passwd="$(accpl.__get_mysql_root_passwd)"
    [[ -z "$passwd" ]] && opt="" || opt="-p"

    if [[ -z "$query" ]]; then
      mysql $opt"$passwd" -u "$user" "$db"
    else
      mysql $opt"$passwd" -u "$user" "$db" <<< "$query"
    fi
  fi
}

function accpl.__run_compass() {
  local BUNDLE COMPASS git_root sassdir sassdir_relative

  BUNDLE="$(command -v bundle)"
  COMPASS="$(command -v compass)"

  [[ -z "$BUNDLE" ]] && errcho "Bundler not found!" && exit 127
  [[ -z "$COMPASS" ]] && errcho "Compass not found!" && exit 127

  git_root="$(accpl.__get_git_root)"
  sassdir="$(accpl.__get_sassdir)"
  errcho "Found: $sassdir"
  cd "$sassdir" || exit

  sassdir_relative="$(sed "s;$git_root/;;" <<< "$sassdir")"

  if accpl.__git_ls_grep "$sassdir_relative/Gemfile"; then # 2> /dev/null; then
    "$BUNDLE" install
    COMPASS="$BUNDLE exec compass"
  fi

  $COMPASS "$@"
}

function accpl.__verbose_run() {
  errcho "Running: $@"
  "$@"
}

function accpl.run_query() {
  local query="$1"

  if accpl.__db_query "$@"; then
    errcho "SUCCESS: '$query'"
  else
    errcho "FAIL: '$query'"
    exit 1
  fi
}

function accpl.__is_mac() {
  [[ $OSTYPE == darwin* ]]
}

function accpl.__is_linux() {
  [[ $OSTYPE == linux-gnu ]]
}

function accpl.__is_git_repo() {
  [[ -d .git ]] || git rev-parse --git-dir > /dev/null 2>&1
}

function accpl.__is_d8() {
  local drupal_root

  drupal_root="$(accpl.__get_drupal_root)"
  [[ -d "$drupal_root/core" ]]
}

function accpl.__is_concrete5() {
  if accpl.__is_git_repo; then
    accpl.__git_ls_grep concrete/config/app.php > /dev/null 2>&1
  else
    return 1
  fi
}

function accpl.__is_drupal() {
  if accpl.__is_git_repo; then
    accpl.__git_ls_grep modules/taxonomy/taxonomy.module > /dev/null 2>&1
  else
    return 1
  fi
}

function accpl.__is_joomla() {
  if accpl.__is_git_repo; then
    accpl.__git_ls_grep libraries/joomla/ > /dev/null 2>&1
  else
    return 1
  fi
}

function accpl.__is_laravel() {
  if accpl.__is_git_repo; then
    accpl.__git_ls_grep 'artisan$' > /dev/null 2>&1
  else
    return 1
  fi
}

function accpl.__is_symfony() {
  if accpl.__is_git_repo; then
    accpl.__git_ls_grep app/SymfonyRequirements.php > /dev/null 2>&1
  else
    return 1
  fi
}

function accpl.__is_wordpress() {
  if accpl.__is_git_repo; then
    accpl.__git_ls_grep wp-admin/index.php > /dev/null 2>&1
  else
    return 1
  fi
}

function accpl.__git_ls_grep() {
  git ls-tree -r "$(accpl.__get_git_current_branch)" --name-only --full-tree | grep "$1"
}

function accpl.__get_git_current_branch() {
  local git_head git_root

  if accpl.__is_git_repo; then
    git_root="$(accpl.__get_git_root)"
    git_head="$(git symbolic-ref HEAD 2> /dev/null)" || git_head="$([[ -f $git_root/.git/HEAD ]] && cat "$git_root/.git/HEAD")"
  fi

  echo "${git_head##refs/heads/}"
}

function accpl.__get_git_root() {
  git rev-parse --show-toplevel 2> /dev/null
}

function accpl.__get_concrete5_creds() {
  local concrete5_root

  concrete5_root="$(accpl.__get_concrete5_root)"
  # Pipe to sort, to ensure: DB_DATABASE DB_PASSWORD DB_USERNAME order.
  # Concrete 5.6:
  if [[ -f "$concrete5_root/config/site.php" ]]; then
    set -- $(egrep 'DB_(DATABASE|PASSWORD|USERNAME)' "$concrete5_root/config/site.php" | sort | cut -d \' -f 4)
  # Concrete 5.7:
  elif [[ -f "$concrete5_root/application/config/database.php" ]]; then
    set -- $(php -r "\$f=require('$concrete5_root/application/config/database.php'); \$f=\$f['connections']['concrete']; print(\$f['database'].' '.\$f['password'].' '.\$f['username']);")
  fi

  # This will fail if any of the results has whitespace
  if [[ $# -ne 3 ]]; then
    set --
  fi

  echo "$@"
}

function accpl.__get_concrete5_root() {
  local git_root is_concrete5 concrete5_root

  git_root="$(accpl.__get_git_root)"
  if [[ ! -z "$git_root" ]]; then
    # concrete5 6, 7, and 8, all seems to have this path to this file:
    is_concrete5="$(accpl.__git_ls_grep concrete/config/app.php)"
    if [[ ! -z "$is_concrete5" ]]; then
      # Strip away: concrete/config/app.php and we'll have our: concrete5_root
      concrete5_root="${is_concrete5/\/concrete\/config\/app.php/}"
    fi
  fi

  echo "$git_root/$concrete5_root"
}

function accpl.__get_drupal_creds() {
  local drupal_root settings_file

  drupal_root="$(accpl.__get_drupal_root)"
  # Pipe to sort, to ensure: db-name, db-password, db-username order, which
  # isn't guaranteed by drush param order
  # local drush_status="$(accpl.__call_drush status --format=yaml --show-passwords db-name db-password db-username | sort)"
  # set -- $(echo "$drush_status" | sed 's/^ *db-[^:][^:]*: //')
  # Drush will fail, if db does not exist
  if [[ -f "$drupal_root/sites/default/local_settings.php" ]]; then
    settings_file="$drupal_root/sites/default/local_settings.php"
  elif [[ -f "$drupal_root/sites/default/settings.local.php" ]]; then
    settings_file="$drupal_root/sites/default/settings.local.php"
  elif [[ -f "$drupal_root/sites/default/settings.php" ]]; then
    settings_file="$drupal_root/sites/default/settings.php"
  fi

  [[ -n "$settings_file" ]] && set -- $(php -r "require('$settings_file');\$d=\$databases['default']['default'];print \$d['database'].' '.\$d['password'].' '.\$d['username'];");

  # This will fail if any of the results has whitespace
  if [[ $# -ne 3 ]]; then
    set --
  fi

  echo "$@"
}

function accpl.__get_drupal_root() {
  local git_root is_drupal drupal_root

  git_root="$(accpl.__get_git_root)"
  if [[ ! -z "$git_root" ]]; then
    # Drupal 6, 7, and 8, all seems to have this path to this file:
    is_drupal="$(accpl.__git_ls_grep modules/taxonomy/taxonomy.module)"
    if [[ ! -z "$is_drupal" ]]; then
      # Strip away: modules/taxonomy/taxonomy.module and we'll have our: drupal_root
      # Drupal 8 path is (currently) prefixed: with core/ ... but, of course, it will
      # still fail if your version of drush doesn't support Drupal 8.
      drupal_root="$(sed 's;core[/]*$;;' <<< "${is_drupal/modules\/taxonomy\/taxonomy.module/}")"
      # Set additional option(s) to pass along to drush...
    fi
  fi

  echo "$git_root/$drupal_root"
}

function accpl.__get_joomla_creds() {
  local joomla_root

  joomla_root="$(accpl.__get_joomla_root)"
  # db password user
  if [[ -f "$joomla_root/configuration.php" ]]; then
    set -- $(php -r "require('$joomla_root/configuration.php'); \$t = new JConfig; print \$t->db.' '.\$t->password.' '.\$t->user;");
  fi

  # This will fail if any of the results has whitespace
  if [[ $# -ne 3 ]]; then
    set --
  fi

  echo "$@"
}

function accpl.__get_joomla_root() {
  local git_root is_joomla joomla_root

  git_root="$(accpl.__get_git_root)"
  if [[ ! -z "$git_root" ]]; then
    # joomla versions all seems to have this path to this folder:
    is_joomla="$(accpl.__git_ls_grep libraries/joomla/ | head -1 | sed 's;/.*$;;')"
    if [[ ! -z "$is_joomla" ]]; then
      # Strip away: libraries/joomla and we'll have our: joomla_root
      joomla_root="${is_joomla/libraries\/joomla/}"
    fi
  fi

  echo "$git_root/$joomla_root"
}

function accpl.__get_laravel_root() {
  local git_root is_laravel laravel_root

  git_root="$(accpl.__get_git_root)"
  if [[ ! -z "$git_root" ]]; then
    # Look for artisan in repo
    is_laravel="$(accpl.__git_ls_grep 'artisan$')"
    if [[ ! -z "$is_laravel" ]]; then
      # Strip away: artisan and we'll have our: laravel_root
      laravel_root="${is_laravel/artisan/}"
    fi
  fi

  echo "$git_root/$laravel_root"
}

function accpl.__get_symfony_root() {
  local git_root is_symfony symfony_root

  git_root="$(accpl.__get_git_root)"
  if [[ ! -z "$git_root" ]]; then
    # Symfony seems to have this path to this file:
    is_symfony="$(accpl.__git_ls_grep app/SymfonyRequirements.php)"
    if [[ ! -z "$is_symfony" ]]; then
      # Strip away: app/SymfonyRequirements.php and we'll have our: symfony_root
      symfony_root="${is_symfony/app\/SymfonyRequirements.php/}"
    fi
  fi

  echo "$git_root/$symfony_root"
}

function accpl.__get_wordpress_creds() {
  local wp_root

  wp_root="$(accpl.__get_wordpress_root)"
  # DB_NAME DB_PASSWORD DB_USER
  # This will fail if DB doesn't exist, as when we're invoking accpl.c :/
  # set $(php -r "require('$wp_root/wp-config.php'); print DB_NAME.' '.DB_PASSWORD.' '.DB_USER;");
  # Pipe to sort, to ensure: DB_NAME, DB_PASSWORD, DB_USER order.
  if [[ -f "$wp_root/local-config.php" ]]; then
    set -- $(egrep 'DB_(NAME|USER|PASSWORD)' "$wp_root/local-config.php" | sort | cut -d \' -f 4)
  elif [[ -f "$wp_root/wp-config.php" ]]; then
    set -- $(egrep 'DB_(NAME|USER|PASSWORD)' "$wp_root/wp-config.php"    | sort | cut -d \' -f 4)
  fi

  # This will fail if any of the results has whitespace
  if [[ $# -ne 3 ]]; then
    set --
  fi

  echo "$@"
}

function accpl.__get_wordpress_root() {
  local git_root is_wordpress wordpress_root

  git_root="$(accpl.__get_git_root)"
  if [[ ! -z "$git_root" ]]; then
    # wordpress 6, 7, and 8, all seems to have this path to this file:
    is_wordpress="$(accpl.__git_ls_grep wp-admin/index.php)"
    if [[ ! -z "$is_wordpress" ]]; then
      # Strip away: wp-admin/index.php and we'll have our: wordpress_root
      wordpress_root="${is_wordpress/\/wp-admin\/index.php/}"
    fi
  fi

  echo "$git_root/$wordpress_root"
}

function accpl.__get_sassdir() {
  local git_root theme sassdir

  git_root="$(accpl.__get_git_root)"
  # Drush seems to emit a ^M char, and a trailing space re: tr, and last sed expression
  if accpl.__is_drupal; then
    if accpl.__is_d8; then
      theme="$(accpl.__call_drush config-get system.theme | grep default: | sed 's/default: //')"
    else
      theme="$(accpl.__call_drush vget theme_default | sed "s/theme_default: //;s/'//g")"
      if [[ -z "$theme" ]]; then
        theme="$(accpl.__call_drush status theme | tr -d $'\r' | grep 'Default theme' | sed 's/^[^:]*:  *//;s/ //g')"
      fi
    fi
    sassdir="$(accpl.__git_ls_grep "$theme/config.rb")"
  elif accpl.__is_wordpress; then
    theme="$(accpl.__call_wp_cli theme status | tail -n +2 | sed 's/^ *//;s/  */:/g' | grep '^A:' | cut -d: -f2)"
    sassdir="$(accpl.__git_ls_grep config.rb | grep "$theme")"
  # TODO: elif accpl.__is_joomla; then
  fi

  [[ -z "$sassdir" ]] && errcho "No config.rb file found!" && exit 1

  echo "$git_root/${sassdir%/*}"
}

function accpl.c() {
  # $1 = $dbname, $2 = $dbpassword, $3 = $dbusername
  set -- $(accpl.__get_mysql_creds)

  if accpl.__db_query "CREATE DATABASE IF NOT EXISTS $1 COLLATE 'utf8_general_ci'" mysql root; then
    accpl.__db_query "GRANT ALL PRIVILEGES ON $1.* TO '$3'@'localhost' IDENTIFIED BY '$2'" mysql root
  else
    errcho "Creation of: '$1' FAILED"
    exit 1
  fi

  errcho "Created: '$1' successfully"
}

function accpl.drop() {
  # $1 = $dbname, $2 = $dbpassword, $3 = $dbusername
  set -- $(accpl.__get_mysql_creds)

  if accpl.__db_query "DROP DATABASE $1" mysql root; then
    accpl.__db_query "DROP USER '$3'@'localhost'" mysql root
  else
    errcho "Destruction of: '$1' FAILED"
    exit 1
  fi

  errcho "Destroyed: '$1' successfully"
}

function accpl.p() {
  # $1 = $dbname, $2 = $dbpassword, $3 = $dbusername
  set -- $(accpl.__get_mysql_creds)

  if [[ "$(accpl.__db_query "SELECT COUNT(*) FROM mysql.user WHERE User='$3'" mysql root | tail -1)" = "1" ]]; then
    stty -echo
    read -r -p "New MySQL password for '$3': " new_mysql_passwd
    stty echo
    echo

    if accpl.__db_query "SET PASSWORD FOR '$3'@'localhost' = PASSWORD('$new_mysql_passwd')" mysql root; then
      errcho "Password change for: '$3' successful"
    fi
  else
    errcho "User: '$3' does not seem to exist"
    exit 1
  fi
}

function accpl.l() {
  # Empty query, gets mysql shell
  accpl.q
}

function accpl.q() {
  accpl.__db_query "$@"
}

function accpl.t() {
  accpl.run_query "SHOW TABLES"
}

function accpl.trunc() {
  [[ -z "$1" ]] && errcho "Give me a table to truncate!" && exit 1
  accpl.run_query "TRUNCATE TABLE $1"
}

function accpl.d() {
  accpl.run_query "SHOW DATABASES" mysql root
}

function accpl.f() {
  accpl.run_query "FLUSH PRIVILEGES" mysql root
}

function accpl.si() {
  local clean_mysql_db drush_output drupal_root

  # [[ -d .git ]] && errcho "This is already a git repo!" && exit 1
  [[ -d drupal ]] || [[ -f drupal ]] && errcho "Drupal folder or file already exists!" && exit 1

  clean_mysql_db="$(accpl.__get_clean_mysql_db)"
  accpl.c

  drush_output="$(drush dl drupal 2>&1)"
  errcho "$drush_output"
  drush_output="$(echo "$drush_output" | grep 'downloaded to ' | sed -e 's;^[^/]*;;' -e 's/\. .*$//')"

  drupal_root="${drush_output%/*}/drupal"

  mv "$drush_output" "$drupal_root"

  mkdir -p "$drupal_root"/sites/all/modules/{contrib,custom,features} "$drupal_root"/sites/all/libraries

  drush -r "$drupal_root"\
    site-install standard   \
      --account-name=admin  \
      --account-pass=admin  \
      --db-url="mysql://$clean_mysql_db:$clean_mysql_db@localhost/$clean_mysql_db"

  ln -svf "${drupal_root##/*/}" webroot
  accpl.fp

  # cd ${GIT_PREFIX:-.} && git init . && git add . && git commit -m 'Initial commit'
}

function accpl.dump() {
  local now branch_name git_root dest_file_base

  now="$(date '+%Y-%m-%d_%H-%M-%S')"
  branch_name="$(accpl.__get_git_current_branch)"
  git_root="$(accpl.__get_git_root)"

  branch_name="${branch_name/[^-_a-zA-Z0-9]/_}"

  [[ ! -d "$git_root/db" ]] && mkdir -p "$git_root/db"
  dest_file_base="${git_root}/db/default_${branch_name}-${now}"

  if accpl.__is_drupal; then
    if accpl.__is_d8; then
      accpl.__call_drush cache-rebuild
    else
      accpl.__call_drush cache-clear all
    fi

    accpl.__call_drush sql-dump --ordered-dump --gzip > "${dest_file_base}.sql.gz"
  elif accpl.__is_wordpress; then
    accpl.__call_wp_cli cache flush
    accpl.__call_wp_cli db export --add-drop-table --skip-extended-insert "${dest_file_base}.sql"
    errcho "... and gzip-ing"
    gzip "${dest_file_base}.sql"
  else
    # $1 = $dbname, $2 = $dbpassword, $3 = $dbusername
    set -- $(accpl.__get_mysql_creds)
    mysqldump -u"$3" -p"$2" "$1" --skip-extended-insert | gzip - > "${dest_file_base}.sql.gz"
  fi

  errcho
  errcho "Dumped to: ${dest_file_base}.sql.gz"
}

function accpl.seed() {
  local CAT

  [[ -z "$1" ]] || [[ ! -f "$1" ]] && errcho "$1 NOT valid!" && exit 1

  case "$1" in
    *.gz)   CAT="gunzip -c";;
    *.zip)  CAT="unzip -p";;
    *)      CAT=cat;;
  esac

  errcho "Seeding from: $1"

  if accpl.__is_drupal; then
    accpl.__call_drush sql-drop -y
    $CAT "$1" | accpl.__call_drush sql-cli
  elif accpl.__is_wordpress; then
    accpl.__call_wp_cli db drop --yes
    accpl.__call_wp_cli db create
    $CAT "$1" | accpl.__call_wp_cli db import -
  else
    local infile="$1"
    # $1 = $dbname, $2 = $dbpassword, $3 = $dbusername
    set -- $(accpl.__get_mysql_creds)
    $CAT "$infile" | mysql -u"$3" -p"$2" "$1"
  fi
}

function accpl.addme() {
  local CMS i username email password roles results uid

  if accpl.__is_drupal; then
    CMS=drupal
  elif accpl.__is_wordpress; then
    CMS=wordpress
  # TODO: elif accpl.__is_joomla; then
  fi

  username="$(accpl.__get_my_${CMS}_username)"
  email="$(accpl.__get_my_${CMS}_email_address)"
  password="$(accpl.__get_my_${CMS}_passwd)"

  if accpl.__is_drupal; then
    roles="$(accpl.__call_drush role-list --filter='administer nodes' --pipe)"

    results="$(accpl.__call_drush user-create "$username" --mail="$email" --password="$password")"
    uid="$(grep 'User ID' <<< "$results" | sed 's/^[^:]*:[[:space:]]*//;s/[[:space:]]*$//')"

    errcho "$results"
    if [[ ! -z "$uid" ]]; then
      while read -r role; do
        accpl.__call_drush user-add-role "$role" "$uid"
      done <<< "$roles"

      if drush pm-list --pipe --type=module --status=enabled --no-core | egrep '\bemail_registration\b' > /dev/null 2>&1; then
        errcho "*************************************************************************************** "
        errcho "***** The 'email_registration' module is enabled. Use your email address to login ***** "
        errcho "*************************************************************************************** "
      fi

      errcho "User Information for User ID: $uid"
      accpl.__call_drush user-information "$uid"
    fi
  elif accpl.__is_wordpress; then
    accpl.__call_wp_cli user create "$username" "$email" --user_pass="$password" --role=administrator
  # TODO: elif accpl.__is_joomla; then
  fi
}

function accpl.ccc() {
  accpl.__run_compass clean
  accpl.__run_compass compile

  if accpl.__is_drupal; then
    if accpl.__is_d8; then
      accpl.__call_drush cr
    else
      accpl.__call_drush cc all
    fi
  elif accpl.__is_wordpress; then
    accpl.__call_wp_cli cache flush
  # TODO: elif accpl.__is_joomla; then
  fi
}

function accpl.cw() {
  accpl.__run_compass watch
}

function accpl.dls() {
  local template clean_mysql_db drupal_root

  template="${0%/*}/../templates/drupal/local_settings.php"
  clean_mysql_db="$(accpl.__get_clean_mysql_db)"
  drupal_root="$(accpl.__get_drupal_root)"
  if [[ -d "$drupal_root/sites/default/" ]]; then
    if [[ ! -f "$drupal_root/sites/default/local_settings.php" ]]; then
      if grep local_settings.php "$drupal_root/sites/default/settings.php" > /dev/null 2>&1; then
        sed -e "s/__MYSQL_DB__/$clean_mysql_db/g"      \
            -e "s/__MYSQL_USER__/$clean_mysql_db/g"    \
            -e "s/__MYSQL_PASSWD__/$clean_mysql_db/g"  \
            $template > "$drupal_root/sites/default/local_settings.php"
      else
        errcho "The $drupal_root/sites/default/settings.php file either doesn't exist, or does not utilize local_settings.php"
      fi
    else
      errcho "Looks like $drupal_root/sites/default/local_settings.php already exists!"
    fi
  else
    errcho "There doesn't seem to be a $drupal_root/sites/default/ folder"
  fi
}

function accpl.adb() {
  # apachectl -t -D DUMP_VHOSTS
  local _apachectl

  _apachectl="$(command -v apachectl)"
  if [[ -z "$_apachectl" ]]; then
    _apachectl="$(command -v apache2ctl)"
  fi

  [[ -z "$_apachectl" ]] && errcho "ApacheCtl not found!" && exit 127

  accpl.__verbose_run sudo "$_apachectl" -S
  accpl.__verbose_run sudo "$_apachectl" configtest
}

function accpl.aa() {
  local log_dir log_file log_viewer options

  log_viewer="$(command -v lnav)"
  if [[ -z "$log_viewer" ]]; then
    log_viewer="tail"
    options='-f'
  fi

  # OSX and Ubuntu
  if [[ -d "/var/log/apache2" ]]; then
    log_dir="/var/log/apache2"
  elif [[ -d "/var/log/httpd" ]]; then
    log_dir="/var/log/httpd"
  else
    errcho "I don't know where your Apache logs are!"
    exit 127
  fi

  if [[ -r "$log_dir/access_log" ]]; then
    log_file="$log_dir/access_log"
  elif [[ -r "$log_dir/access.log" ]]; then
    log_file="$log_dir/access.log"
  else
    errcho "I don't know what your Apache access logs are named!"
    exit 127
  fi

  "$log_viewer" $options "$log_file"
}

function accpl.ae() {
  local log_dir log_file log_viewer options

  log_viewer="$(command -v lnav)"
  if [[ -z "$log_viewer" ]]; then
    log_viewer="tail"
    options='-f'
  fi

  # OSX and Ubuntu
  if [[ -d "/var/log/apache2" ]]; then
    log_dir="/var/log/apache2"
  elif [[ -d "/var/log/httpd" ]]; then
    log_dir="/var/log/httpd"
  else
    errcho "I don't know where your Apache logs are!"
    exit 127
  fi

  if [[ -r "$log_dir/error_log" ]]; then
    log_file="$log_dir/error_log"
  elif [[ -r "$log_dir/error.log" ]]; then
    log_file="$log_dir/error.log"
  else
    errcho "I don't know what your Apache error logs are named!"
    exit 127
  fi

  "$log_viewer" $options "$log_file"
}

function accpl.fp() {
  local apache_group files_root writable i chmod_options

  # Apache confs have "Group" but Ubuntu uses env vars, so for now use...
  accpl.__is_mac && apache_group=_www || apache_group=www-data

  if [[ $# -gt 0 ]]; then
    files_root="."
    writable=(
      "$@"
    )
  elif accpl.__is_concrete5; then
    files_root="$(accpl.__get_concrete5_root)"
    # This list accomodates both version 5.6 and 5.7
    writable=(
      'application/config'
      'application/files'
      'config'
      'files'
      'packages'
      'updates'
    )
  elif accpl.__is_drupal; then
    files_root="$(accpl.__get_drupal_root)"
    writable=(
      'sites/default/files'
    )
  elif accpl.__is_joomla; then
    files_root="$(accpl.__get_joomla_root)"
    writable=(
      'administrator/cache'
      'administrator/components'
      'administrator/language'
      'administrator/manifests/files'
      'administrator/manifests/libraries'
      'administrator/manifests/packages'
      'administrator/modules'
      'administrator/templates'
      'cache'
      'components'
      'configuration.php'
      'images'
      'language'
      'libraries'
      'logs'
      'media'
      'modules'
      'plugins'
      'plugins/authentication'
      'plugins/captcha'
      'plugins/content'
      'plugins/editors'
      'plugins/editors-xtd'
      'plugins/extension'
      'plugins/finder'
      'plugins/quickicon'
      'plugins/search'
      'plugins/system'
      'plugins/twofactorauth'
      'plugins/user'
      'templates'
      'tmp'
    )
  elif accpl.__is_laravel; then
    files_root="$(accpl.__get_laravel_root)"
    writable=(
      'bootstrap/cache'
      'public/uploads'
      'storage'
    )
  elif accpl.__is_symfony; then
    files_root="$(accpl.__get_symfony_root)"
    writable=(
      'app/cache'
      'app/logs'
    )
  elif accpl.__is_wordpress; then
    files_root="$(accpl.__get_wordpress_root)"
    writable=(
      'wp-content'
    )
  else
    files_root="."
    writable=(
      "$@"
    )
  fi

  if accpl.__is_mac; then
    # http://apple.stackexchange.com/questions/13132/how-to-add-user-to-a-group-on-command-line
    if ! dseditgroup -o checkmember -m "$USER" "$apache_group" > /dev/null; then
      accpl.__verbose_run sudo dseditgroup -o edit -a "$USER" -t user "$apache_group"
    fi
  elif accpl.__is_linux; then
    # NOTE: adding a group doesn't show until user logs out and back in.
    if ! groups | egrep "\b$apache_group\b" > /dev/null; then
      accpl.__verbose_run sudo usermod -a -G "$apache_group" "$USER"
    fi
  else
    errcho "Unrecognized \$OSTYPE: $OSTYPE"
    exit 1
  fi

  [[ ! -d "$files_root" ]] && mkdir -p "$files_root"

  accpl.__is_linux && chmod_options=-c || chmod_options=-vv

  for i in ${writable[*]}; do
    if [[ -d "$files_root/$i" ]] || [[ -f "$files_root/$i" ]]; then
      # Quick hack, to allow for symlinked folders. Find and chown have -L
      # option on OSX and Linux, but chmod does not under Linux.
      [[ -d "$files_root/$i" ]] && i="$i/"
      # For "prod" use:   sudo chgrp -R $apache_group "$files_root/$i"
      accpl.__verbose_run sudo chown -R "$USER:$apache_group" "$files_root/$i"
      accpl.__verbose_run sudo chmod -R $chmod_options ug+rw "$files_root/$i" 2> /dev/null | grep -v "’ retained as "
      accpl.__verbose_run sudo find "$files_root/$i" -type d -exec chmod $chmod_options g+s {} \; -a -exec chmod $chmod_options o-stw {} \; | grep -v "’ retained as "
    fi
  done
}

function accpl.els() {
  local drupal_root git_editor settings_file

  drupal_root="$(accpl.__get_drupal_root)"
  if [[ -f "$drupal_root/sites/default/local_settings.php" ]]; then
    settings_file="$drupal_root/sites/default/local_settings.php"
  elif [[ -f "$drupal_root/sites/default/settings.local.php" ]]; then
    settings_file="$drupal_root/sites/default/settings.local.php"
  elif [[ -f "$drupal_root/sites/default/settings.php" ]]; then
    settings_file="$drupal_root/sites/default/settings.php"
  fi

  if [[ ! -z "$settings_file" ]]; then
    git_editor="$(git config core.editor)" || git_editor="${EDITOR:-vim}"

    "$git_editor" "$settings_file"
  fi
}

function accpl.ssh() {
  local branch cap_conf SSH user gateway

  branch="$(accpl.__get_git_current_branch)"
  cap_conf="$(accpl.__git_ls_grep "/${branch}.rb" 2> /dev/null)"
  SSH="echo"
  if [[ -f "$cap_conf" ]]; then
    # config/deploy/prod.rb:15:ssh_options[:user] = 'deploy'
    user="$(git grep "ssh_options\[:user\]" "$cap_conf" | egrep -o "('|\")[^'\"]+('|\")" | sed 's/[^0-9a-zA-Z.-]//g')"
    # config/deploy/prod.rb:8:set :gateway, 'xxx.xxx.xxx.xxx'
    gateway="$(git grep ":gateway" "$cap_conf" | egrep -o "('|\")[^'\"]+('|\")" | sed 's/[^0-9a-zA-Z.-]//g')"
    [[ ! -z "$user" ]] && [[ ! -z "$gateway" ]] && SSH=ssh
    $SSH "$user@$gateway"
  else
    echo "There doesn't seem capistrano config file for the $branch branch!"
    exit 1
  fi
}

function accpl.genssl() {
  # http://www.jamescoyle.net/how-to/1073-bash-script-to-create-an-ssl-certificate-key-and-request-csr
  # http://www.freesoftwaremagazine.com/articles/generating_self_signed_test_certificates_using_one_single_shell_script
  # http://www.akadia.com/services/ssh_test_certificate.html
  local domain C ST L O OU CN emailAddress password

  # Change to your company details
  C=US;  ST=Oregon;  L=Portland; O=$domain; # Country, State, Locality, Organization
  OU=IT; CN=$domain; emailAddress="$(git config user.email)"

  [[ -z "$1" ]] && domain=server || domain="$1"

  # Change to your company details
  C=US;  ST=Oregon;  L=Portland; O=$domain; # Country, State, Locality, Organization
  OU=IT; CN=$domain; emailAddress="$(git config user.email)"
  # Common Name, Email Address, Organizational Unit

  #Optional
  password=dummypassword
  # Step 1: Generate a Private Key
  openssl genrsa -des3 -passout pass:$password -out ${domain}.key 2048 -noout
  # Step 2: Generate a CSR (Certificate Signing Request)
  openssl req -new -key ${domain}.key -out ${domain}.csr -passin pass:$password \
    -subj "/C=$C/ST=$ST/L=$L/O=$O/OU=$OU/CN=$CN/emailAddress=$emailAddress"
  # Step 3: Remove Passphrase from Key. Comment the line out to keep the passphrase
  openssl rsa -in ${domain}.key -passin pass:$password -out ${domain}.key
  # Step 4: Generating a Self-Signed Certificate
  openssl x509 -req -days 3650 -in ${domain}.csr -signkey ${domain}.key -out ${domain}.crt

  ls -l ${domain}.*
}

function accpl.exfe() {
  local drupal_root features_root feature

  if accpl.__is_drupal; then
    drupal_root="$(accpl.__get_drupal_root)"

    feature="$(accpl.exam "$@" | tail +2 | sed 's|/.*$||' | grep -o '[^ ]*$' | sort -u)"
    features_root="$(accpl.__git_ls_grep "/$feature/" | sed 's|/[^/]*$||' | sort -u)"

    if [[ -n "$features_root" ]]; then
      features_root="${features_root%/*}"
    else
      if [[ -d "$drupal_root/sites/all/modules/features" ]]; then
        features_root="$drupal_root/sites/all/modules/features"
      elif [[ -d "$drupal_root/sites/all/modules/custom" ]]; then
        features_root="$drupal_root/sites/all/modules/custom"
      elif [[ -d "$drupal_root/sites/all/modules" ]]; then
        features_root="$drupal_root/sites/all/modules"
      else
        errcho "The $drupal_root/sites/all/modules folder doesn't seem to exist"
        exit 1
      fi
    fi
  else
    errcho "This doesn't seem to be a drupal project"
    exit 1
  fi

  local _pwd=$PWD
  cd "$features_root" || exit

  PREFIX=$_pwd accpl.ex "$@" && errcho "Extracted to: $features_root"
}

function accpl.dinit() {
    local stage="prod"
    [[ ! -z "$1" ]] && stage="$1"

    accpl.dls
    accpl.c

    cd "$(accpl.__get_git_root)" || exit

    cap "$stage" db:down
    accpl.seed "db/default_${stage}.sql"

    cap "$stage" files:pull
    accpl.fp "$@"

    gzip "db/default_${stage}.sql"
}

function accpl.exam() {
  accpl.ex "$@"
}

# https://github.com/myfreeweb/zshuery
#   Added "s around $variable, and in a for loop
function accpl.ex() {
  local i option_tar option_gunzip option_unrar option_unzip option_uncompress

  # For more info, while in bash: help caller
  if caller 0 | grep "\\.exam " > /dev/null; then
    option_tar=t
    option_gunzip=-t
    option_unrar=l
    option_unzip=-l
    option_uncompress=echo
  else
    option_tar=x
    option_gunzip=
    option_unrar=x
    option_unzip=
    option_uncompress=
  fi

  for i in "$@"; do
    [[ ! -z "$PREFIX" ]] && [[ $i != /* ]] && i=$PREFIX/$i
    if [[ -f "$i" ]]; then
      errcho "Working on: $i"
      case "$i" in
        *.tar)        tar ${option_tar}vf   "$i";;
        *.tar.gz)     tar ${option_tar}vzf  "$i";;
        *.tgz)        tar ${option_tar}vzf  "$i";;
        *.tar.xz)     tar ${option_tar}vJf  "$i";;
        *.tar.bz2)    tar ${option_tar}vjf  "$i";;
        *.tbz2)       tar ${option_tar}vjf  "$i";;
        *.tar.lzma)   tar --lzma ${option_tar}vf "$i";;
        *.7z)         7z  ${option_tar}     "$i";;
        *.gz)   gunzip    ${option_gunzip}  "$i";;
        *.bz2)  bunzip2   ${option_gunzip}  "$i";;
        *.rar)  unrar     ${option_unrar}   "$i";;
        *.zip)  unzip     ${option_unzip}   "$i";;
        *.Z)    $option_uncompress uncompress "$i";;
        *.dmg)  hdiutul mount "$i";; # mount OS X disk images
        *) errcho "'$i' cannot be extracted via >ex<"
           return 1;;
      esac
    else
      errcho "'$i' is not a valid file"
      return 1
    fi
  done
}

function accpl.cd() {
  if accpl.__is_drupal; then
    local DRUPAL_CLONE drupal_version drupal_root git_root TMP

    DRUPAL_CLONE=$HOME/.ghq/git.drupal.org/project/drupal
    [[ ! -d "$DRUPAL_CLONE/.git" ]] && errcho "No drupal clone" && exit 1

    drupal_version="$(drush status drupal-version --format=list)"
    drupal_root="$(accpl.__get_drupal_root)"
    git_root="$(accpl.__get_git_root)"
    TMP="/tmp/drupal-$drupal_version-$$"

    mkdir -p "$TMP"
    pushd "$TMP" > /dev/null

    for i in $(git --git-dir="$DRUPAL_CLONE/.git" archive "$drupal_version" | tar xvf - 2>&1 | sed 's/^x //' | grep -v '/$'); do
      diff -U 0 -N -w "$i" "$drupal_root/$i"
    done | tee "$git_root/core-diff.diff"
    errcho "$(tput setaf 3)Output saved to: $(tput setaf 5)'$git_root/core-diff.diff'$(tput sgr0)"

    popd > /dev/null
    rm -rf "$TMP"
  else
    errcho "This doesn't look like drupal" && exit 1
  fi
}

function accpl.cus() {
  if accpl.__is_drupal; then
    local DRUPAL_CLONE drupal_version

    DRUPAL_CLONE=$HOME/.ghq/git.drupal.org/project/drupal
    [[ ! -d "$DRUPAL_CLONE/.git" ]] && errcho "No drupal clone" && exit 1

    drupal_version="$(drush status drupal-version --format=list)"
    # TODO: programmaticlly determine prefix (vs. hard-coded 'drupal', and for
    # modules folder contents not in {contrib,custom,features}
    comm -13  <(git --git-dir="$DRUPAL_CLONE/.git" ls-tree --name-only -r "$drupal_version" | sed 's;^;drupal/;' | sort) \
              <(git ls-tree --name-only -r HEAD | grep -v -e sites/all/modules/contrib/ -e sites/all/libraries/ | sort)
  else
    errcho "This doesn't look like drupal" && exit 1
  fi
}

# "main()" if not "source"-d
#   declare -F, for function names
#   declare -f, for function definitions
if [[ "${BASH_SOURCE[0]}" = "${0}" ]]; then
  # Allow for function names to be sym- or hard-linked to this script
  type -t "accpl.${accpl_self}" > /dev/null && subcommand="$accpl_self" || {
    subcommand="$1"
    shift
  }

  case $subcommand in
    "" | "-h" | "--help")
      accpl.help
      ;;
    *)
      "accpl.${subcommand}" "$@"
      if [[ $? -eq 127 ]]; then
        cat <<EOT >&2
Error: '$subcommand' is not a known subcommand.
EOT
        exit $?
      fi
      ;;
  esac
fi
